<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.adrvil.wealthcheck.mapper.TransactionMapper">

    <select id="countTransactions" resultType="long">
        SELECT COUNT(*)
        FROM transactions
        WHERE user_id = #{userId}
        AND soft_deleted = #{softDeleted}

        <!-- type filter -->
        <if test="filter.type != null">
            AND type = #{filter.type}::transaction_type
        </if>

        <!-- wallet filter -->
        <if test="filter.walletId != null">
            AND (from_wallet_id = #{filter.walletId} OR to_wallet_id = #{filter.walletId})
        </if>

        <!-- category filter -->
        <if test="filter.categoryId != null">
            AND category_id = #{filter.categoryId}
        </if>

        <choose>
            <!-- Single day - use range for index -->
            <when test="filter.fromDate != null and filter.toDate != null and filter.fromDate.equals(filter.toDate)">
                AND transaction_date &gt;= #{filter.fromDate}::date
                AND transaction_date &lt; (#{filter.fromDate}::date + INTERVAL '1 day')
            </when>
            <!-- Date range - use range for index -->
            <when test="filter.fromDate != null and filter.toDate != null">
                AND transaction_date &gt;= #{filter.fromDate}::date
                AND transaction_date &lt; (#{filter.toDate}::date + INTERVAL '1 day')
            </when>
            <!-- Only from date -->
            <when test="filter.fromDate != null">
                AND transaction_date &gt;= #{filter.fromDate}::date
            </when>
            <!-- Only to date -->
            <when test="filter.toDate != null">
                AND transaction_date &lt; (#{filter.toDate}::date + INTERVAL '1 day')
            </when>
        </choose>

        <!-- search -->
        <if test="filter.search != null and filter.search != ''">
            AND (
            title ILIKE '%' || #{filter.search} || '%'
            OR notes ILIKE '%' || #{filter.search} || '%'
            OR title % #{filter.search}
            )
        </if>
    </select>


    <select id="findTransactions"
            resultType="com.adrvil.wealthcheck.dto.response.TransactionRes">
        SELECT
        t.id,
        t.title,
        t.notes,
        t.amount,
        t.from_wallet_id AS fromWalletId,
        t.to_wallet_id AS toWalletId,
        t.category_id AS categoryId,
        fw.name AS fromWalletName,
        tw.name AS toWalletName,
        c.name AS categoryName,
        c.icon AS categoryIcon,
        t.type,
        t.transaction_date,
        t.created_at AS createdAt,
        t.updated_at AS updatedAt
        FROM transactions t
        LEFT JOIN wallet fw
        ON t.from_wallet_id = fw.id
        AND fw.user_id = #{userId}
        AND fw.soft_deleted = FALSE
        LEFT JOIN wallet tw
        ON t.to_wallet_id = tw.id
        AND tw.user_id = #{userId}
        AND tw.soft_deleted = FALSE
        LEFT JOIN category c
        ON t.category_id = c.id
        AND c.user_id = #{userId}
        AND c.soft_deleted = FALSE
        WHERE t.user_id = #{userId}
        AND t.soft_deleted = #{softDeleted}

        <!-- type filter -->
        <if test="filter.type != null">
            AND t.type = #{filter.type}::transaction_type
        </if>

        <!-- wallet filter -->
        <if test="filter.walletId != null">
            AND (t.from_wallet_id = #{filter.walletId} OR t.to_wallet_id = #{filter.walletId})
        </if>

        <!-- category filter -->
        <if test="filter.categoryId != null">
            AND t.category_id = #{filter.categoryId}
        </if>

        <!-- Date filters - consistent with countTransactions -->
        <choose>
            <!-- Single day - use range for index -->
            <when test="filter.fromDate != null and filter.toDate != null and filter.fromDate.equals(filter.toDate)">
                AND t.transaction_date &gt;= #{filter.fromDate}::date
                AND t.transaction_date &lt; (#{filter.fromDate}::date + INTERVAL '1 day')
            </when>
            <!-- Date range - use range for index -->
            <when test="filter.fromDate != null and filter.toDate != null">
                AND t.transaction_date &gt;= #{filter.fromDate}::date
                AND t.transaction_date &lt; (#{filter.toDate}::date + INTERVAL '1 day')
            </when>
            <!-- Only from date -->
            <when test="filter.fromDate != null">
                AND t.transaction_date &gt;= #{filter.fromDate}::date
            </when>
            <!-- Only to date -->
            <when test="filter.toDate != null">
                AND t.transaction_date &lt; (#{filter.toDate}::date + INTERVAL '1 day')
            </when>
        </choose>

        <!-- Full-text search - consistent with countTransactions -->
        <if test="filter.search != null and filter.search != ''">
            AND (
            t.title ILIKE '%' || #{filter.search} || '%'
            OR t.notes ILIKE '%' || #{filter.search} || '%'
            OR t.title % #{filter.search}
            )
        </if>

        ORDER BY t.transaction_date DESC

        <!-- pagination -->
        <if test="filter.page != null and filter.size != null">
            LIMIT #{filter.size} OFFSET ${(filter.page - 1) * filter.size}
        </if>
    </select>

</mapper>
